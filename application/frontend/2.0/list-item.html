{% extends 'index.html' %}

{% block title %}Project{% if code %}: {{ code }}{% endif %} | Geostore{% endblock %}

{% block style %}
	<link rel="stylesheet" type="text/css" href="/css/2.0/dropzone.min.css">
	<link rel="stylesheet" type="text/css" href="/css/2.0/bootstrap-datepicker.min.css">
	<link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/css/select2.min.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="/css/2.0/dashboard.css">
{% endblock %}
{% block content %}
{% include '2.0/navigation.html' %}
<div class="container">
	<ol class="breadcrumb">
		<li><a href="/">Geostore</a></li>
		<li><a href="/projects">Projects</a></li>
		<li><a href="/projects/{{ program }}">{{ program.upper() }}</a></li>
		{% if code %}<li><a href="/projects/{{ program }}/{{ code }}" class="active">{{ code.upper() }}</a></li>{% endif %}
	</ol>
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 p0">
            {% if not code %}
            <div class="alert alert-info"><strong>Hello!</strong> You are adding a new project. </div>
            {% else %}
            {% if new %}
            <div class="alert alert-success"><strong>Success!</strong> You have successfully created a new project.</div>
            {% endif %}
            {% if updated %}
            <div class="alert alert-success"><strong>Success!</strong> The project has been successfully updated!</div>
            {% endif %}
            <div class="alert alert-info"><!-- <i class="fa fa-fw fa-warning"></i> --> Hello! You are viewing this project. You may also add <strong>Geotagged Images, KML Tracks, and Other Files</strong> to this project, by clicking <strong>"Add a New Dataset"</strong> below. </div>
            {% endif %}
    </div>
	<h3><i class="glyphicon glyphicon-info-sign h3-icon"></i> Project Details {% if project_id %}<a class="btn btn-success" href="/viewer?project_id={{ project_id }}">View on Map</a>{% endif %}</h3>

	<form method="post">
		<div class="col-md-8">
			<div class="row">
				<div class="col-md-12"><h4 class="background"><span>Main Details</span></h4></div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>Name</label>
						<input type="text" required="required" name="title" class="form-control">
					</div>
				</div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>ID (Autogenerated)</label>
						<input type="text" name="code" id="project-code-field" required="required" readonly="readonly" class="form-control">
					</div>
				</div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>Region</label>
                        <select name="region" class="form-control" onchange="select_province()">
                            <option data-psgc="18" value="NIR">NIR - Negros Island Region</option>
                            <option data-psgc="13" value="NCR">NCR - National Capital Region</option>
                            <option data-psgc="14" value="CAR">CAR - Cordillera Administrative Region</option>
                            <option data-psgc="01" value="ILOCOS">REGION I (Ilocos Region)</option>
                            <option data-psgc="02" value="CAGAYAN-VALLEY">REGION II (Cagayan Valley)</option>
                            <option data-psgc="03" value="CENTRAL-LUZON">REGION III (Central Luzon)</option>
                            <option data-psgc="04" value="CALABARZON">REGION IV-A (CALABARZON)</option>
                            <option data-psgc="17" value="MIMAROPA">REGION IV-B (MIMAROPA)</option>
                            <option data-psgc="05" value="BICOL">REGION V (Bicol Region)</option>
                            <option data-psgc="06" value="WESTERN-VISAYAS">REGION VI (Western Visayas)</option>
                            <option data-psgc="07" value="CENTRAL-VISAYAS">REGION VII (Central Visayas)</option>
                            <option data-psgc="08" value="EASTERN-VISAYAS">REGION VIII (Eastern Visayas)</option>
                            <option data-psgc="09" value="ZAMBOANGA">REGION IX (Zamboanga Peninsula)</option>
                            <option data-psgc="10" value="NORTHERN-MINDANAO">REGION X (Northern Mindanao)</option>
                            <option data-psgc="11" value="DAVAO">REGION XI (Davao Region)</option>
                            <option data-psgc="12" value="SOCCSKARGEN">REGION XII (Soccsksargen)</option>
                            <option data-psgc="16" value="CARAGA">REGION XIII (Caraga)</option>
                            <option data-psgc="15" value="ARMM">ARMM - Autonomous Region in Muslim Mindana</option>
                        </select>
					</div>
				</div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label>Year</label>
                        <select name="year" class="form-control">
                            <option value="2000">2000</option>
                            <option value="2001">2001</option>
                            <option value="2002">2002</option>
                            <option value="2003">2003</option>
                            <option value="2004">2004</option>
                            <option value="2005">2005</option>
                            <option value="2006">2006</option>
                            <option value="2007">2007</option>
                            <option value="2008">2008</option>
                            <option value="2009">2009</option>
                            <option value="2010">2010</option>
                            <option value="2011">2011</option>
                            <option value="2012">2012</option>
                            <option value="2013">2013</option>
                            <option value="2014">2014</option>
                            <option value="2015">2015</option>
                            <option value="2016">2016</option>
                            <option value="2017">2017</option>
                            <option value="2018">2018</option>
                            <option value="2019">2019</option>
                            <option value="2020">2020</option>
                        </select>
                    </div>
                </div>
				<div class="col-md-12">
					<div class="form-group">
						<label>Description</label>
						<textarea class="form-control" rows="6" name="description"></textarea>
					</div>
				</div>
				<div class="col-md-12" style="display: none;"><h4 class="background"><span>Upload Pictures & KML Files</span></h4></div>
				<div class="col-xs-12" style="display: none;">
					<div class="dropzone" id="dropzone-1">
						<div class="dz-message">Drop Image & KML Files here to upload</div>
					</div>
				</div>
				<div class="col-md-12" style="display: none;"><h4 class="background"><span>Upload Special Findings, Observations, and Other Files</span></h4></div>
				<div class="col-xs-12" style="display: none;">
					<div class="dropzone" id="dropzone-2">
						<div class="dz-message">Drop Special Findings Images here to upload</div>
					</div>
				</div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>Contract Cost</label>
						<input type="text" name="contract-cost" required="required" class="form-control" />
					</div>
				</div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>Total Project Cost</label>
						<input type="text" name="total-project-cost" required="required" class="form-control" />
					</div>
				</div>
				<div class="col-md-12"><h4 class="background"><span>Location</span></h4></div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>Province</label>
						<!-- <input type="text" name="province" class="form-control" disabled=""> -->
						<select name="province" required="required" class="form-control" disabled="" onchange="select_municipality();"></select>
					</div>
				</div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>Municipality</label>
						<!-- <input type="text" name="municipality" class="form-control" disabled=""> -->
						<select name="municipality" required="required" class="form-control" disabled=""></select>
					</div>
				</div>
				<div class="col-md-12 select-agency-program-label" {% if program != 'coa' %}style="display: none;"{% endif %}><h4 class="background"><span>Agency & Program</span></h4></div>
				<div id="select-agency-program">
					<div class="col-xs-6">
						<div class="form-group">
							<label>Agency</label>
							<select class="form-control" name="agency">
								<option selected="" disabled="">Please Select Agency</option>
								{% for agency in agencies %}
								<option value="{{ agency.key.id() }}" data-slug="{{ agency.slug }}">{{ agency.name }}</option>
								{% endfor %}
							</select>
						</div>
					</div>
					<div class="col-xs-6">
						<div class="form-group">
							<label>Program</label>
							<select class="form-control" name="program" disabled=""></select>
						</div>
					</div>
                </div>
				<!-- <div class="imported-project-information">
					<div class="col-md-12" id="more-information-title"><h4 class="background"><span>More Information</span></h4></div>
					<div class="col-md-12">
						<table class="table table-hover meta-information"></table>
					</div>
				</div> -->
			</div>
		</div>
		<div class="col-md-4" id="dashboard-sidebar">
			{% if code %}
			<h4 class="background"><span>Datasets</span></h4>
			<ul class="list-unstyled datasets-list"></ul>
			<ul class="list-inline datasets">
				<li>
					<a href="/projects/{{ program }}/{{ code }}/dataset/new" class="btn btn-xs btn-success" {% if not has_environment %}disabled{% endif %}>Add a New Dataset</a>
				</li>
			</ul>

			<h4 class="background"><span>Subprojects</span></h4>
			<ul class="list-unstyled subprojects-list"></ul>
			<ul class="list-inline cf">
				<li>
					<a href="/projects/{{ program }}/{{ code }}/subproject/new" class="btn btn-xs btn-success">Add a New Subproject</a>
				</li>
			</ul>
			{% endif %}
			<h4 class="background"><span>Project Preview</span></h4>
			<div class="subproject-preview">
                <div id="sample-label" style="display: none;">&nbsp;Sample Data&nbsp;</div>
				<div style="padding: 1em 0;">
					<span class="preview-type">MIMAROPA</span>
					<span class="preview-id">IB-R04B-ORM-0001-VIC-0000-14</span>
				</div>
				<div style="margin: 1em 0;"><span class="preview-name">Concreting of Bagong Silang - Macatoc FMR</span> <span class="preview-status">2014</span></div>
				<div class="preview-description">Concreting of 1.851 km farm to market road with 5 meter wide with sectional concreting works of 420.40 meters by 1 meter and 516.20 by 2 meters.</div>
				<div class="preview-label">Province: <span class="preview-province">Oriental Mindoro</span></div>
				<div class="preview-label">Municipality: <span class="preview-municipality">Victoria</span></div>
				<div class="preview-label">Contract Cost: <span class="preview-contract-cost">1,234,567.89</span></div>
				<div class="preview-label">Total Project Cost: <span class="preview-total-project-cost">1,234,567.89</span></div>
			</div>
			<div class="form-group">
				{% if code %}
				<input type="hidden" name="data">
				<input type="submit" class="btn btn-block btn-success" value="Update" disabled="">
				{% else %}
				<input type="submit" class="btn btn-block btn-success" value="Create" disabled="">
				{% endif %}
			</div>
		</div>
	</form>
</div>

<div class="container">
    <h4 id="audit-logs-click-to-view">Audit Logs <small>Click to view</small></h4>

    <div id="project-logs-container">
    </div>
    <br />
    <br />
    <br />
    <br />
    
</div>

{% endblock %}
{% block script %}

<script type="text/template" id="template-log">
    <div class='log-item'>
        <span class='log-type'>%%type%%</span> 
        <span class='log-operation label label-%%label_class%%'>%%operation%%</span> 
        <span class='log-username'>by %%username%%</span> 
        <span class='log-time'>on %%time%%</span>
        <br />
        <br />
        <span class="log-details">%%details%%</span>
    </div>
</script>

<script type="text/javascript" src="/js/2.0/dropzone.min.js"></script>
<script type="text/javascript" src="/js/2.0/moment.min.js"></script>
<script type="text/javascript" src="/js/2.0/bootstrap-datepicker.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/js/select2.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-maskmoney/3.0.2/jquery.maskMoney.min.js"></script>
<script type="text/javascript" src="/js/2.0/extensions.js"></script>
<script type="text/javascript" src="/js/2.0/dashboard.js?v={{ version }}"></script>
<script type="text/javascript" src="/js/2.0/dashboard.item.events.js?v={{ version }}"></script>
<script src="https://cdn.ravenjs.com/3.0.4/raven.min.js"></script>
<script type="text/javascript">
	Raven.config('https://40dee6edeb0548f99e483cf64b74a5c1@app.getsentry.com/77892').install()
</script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-72730623-1', 'auto');
    ga('send', 'pageview');

</script>
<script type="text/javascript">
	var config = {
		'program': '{{ program }}',
		'code': '{{ code }}',
		'loaded': {},
		'url': '{{ app_url }}',
		'locations': {},
	};
	get_psgc();
	Dropzone.autoDiscover = false;
	var dropzone_1 = new Dropzone("#dropzone-1", { url: "/upload/{{ program }}/{{ code }}"});
	var dropzone_2 = new Dropzone("#dropzone-2", { url: "/upload/{{ program }}/{{ code }}?special=1"});
	$('select[name="agency"], select[name="program"], select[name="region"], select[name="year"]').select2();
	$('input[name*="-date"]').datepicker({format: 'MM d, yyyy'});
	$('input, textarea').on('keyup', function() {
		preview_subproject();
	});
    $('select').on('change', function() {
        preview_subproject(true);
    });
    $('input[name="total-project-cost"], input[name="contract-cost"]').maskMoney();
    window.there_is_a_project_already = false;
	{% if code %}
    window.there_is_a_project_already = true;
	setTimeout(function() {
		get_project(config.program, config.code);
		get_project_datasets(config.program, config.code);
		get_project_subprojects(config.program, config.code);
	}, 1000);
    {% else %}
    $(document).ready(function(){
        $("#sample-label").show();
    });
	{% endif %}
	// set_programs();
</script>

<script type="text/javascript">

    function toTitleCase(str)
    {
        return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
    }

    function convert_json_to_normal(json_object){
        var normal_strings = [];
        for(var key in json_object){
            if(json_object[key] !== null && typeof json_object[key] === 'object'){
                normal_strings.push(convert_json_to_normal(json_object[key]));
            }
            else {
                normal_strings.push(toTitleCase(key).replace('/_/g', ' ') + ': ' + json_object[key]);
            }
        }
        return normal_strings.join('<br />');
    }


    function set_to_loading(){
        $("#project-logs-container").html("Loading...");
    }


    function pull_audit_logs(){
        set_to_loading();

        // get dataset changes
        url2 = '/api/v1/logs?code={{ code }}';
        $.getJSON(url2, function(data){
            if(data){
                console.log('logs 2', data);
                var logs = data.data;

                var html = '';

                for(var i=0; i<logs.length; i++){
                    template = $('#template-log').html();
                    template = template.replace('%%username%%', logs[i].username);
                    template = template.replace('%%operation%%', logs[i].operation);
                    template = template.replace('%%type%%', logs[i].details.type);
                    template = template.replace('%%time%%', logs[i].created);

                    template = template.replace('%%details%%', convert_json_to_normal(logs[i].details));

                    if(logs[i].operation == 'CREATED'){
                        template = template.replace('%%label_class%%', 'success');
                    }
                    else {
                        template = template.replace('%%label_class%%', 'info');
                    }

                    html += template;
                }

                $("#project-logs-container").html(html);
            }
        });
    }


    $(document).ready(function(){
        $("#audit-logs-click-to-view").on('click', function(){
            pull_audit_logs();
        });
        $('select[name="agency"]').on('change', function() {
        	var agency = $(this).val();
        	get_programs_by_agency(agency);
        });
        $('body').on('change', 'select[name="program"]', function() {
        	console.log($(this).val());
        });
    });
</script>

{% endblock %}