{% extends 'index.html' %}

{% block title %}Subproject{% if code %}: {{ code }}{% endif %} | Geostore{% endblock %}
{% block style %}
	<link rel="stylesheet" type="text/css" href="/css/2.0/dropzone.min.css">
	<link rel="stylesheet" type="text/css" href="/css/2.0/bootstrap-datepicker.min.css">
	<link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/css/select2.min.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="/css/2.0/dashboard.css">
{% endblock %}
{% block content %}
{% include '2.0/navigation.html' %}
<div class="container">
	{% if code %}<a href="/projects/{{ program }}/{{ code }}" class="back-to-main-btn"><i class="glyphicon glyphicon-chevron-left"></i> back to main project</a>{% endif %}
	<ol class="breadcrumb">
		<li><a href="/">Geostore</a></li>
		<li><a href="/projects">Dashboard</a></li>
		<li><a href="/projects/{{ program }}">{{ program.upper() }}</a></li>
		{% if code %}<li><a href="/projects/{{ program }}/{{ code }}">{{ code.upper() }}</a></li>{% endif %}
		{% if subproject %}<li><a href="/projects/{{ program }}/{{ code }}/{{ subproject }}">{{ subproject.upper() }}</a></li>{% endif %}
	</ol>
	{% if updated %}
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 p0">
        <div class="alert alert-success"><strong>Success!</strong> The subproject has been successfully updated!</div>
    </div>
	{% endif %}
	<h3><i class="glyphicon glyphicon-info-sign h3-icon"></i> Subproject Details {% if project_id %}<a class="btn btn-success" href="/viewer?project_id={{ project_id }}">View on Map</a>{% endif %}</h3>

	<form method="post">
		<div class="col-md-8">
			<div class="row">
				<div class="col-md-12"><h4 class="background"><span>Main Details</span></h4></div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>Name</label>
						<input type="text" required="required" name="title" class="form-control">
					</div>
				</div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>ID (Autogenerated)</label>
                        <input type="text" name="code" id="project-code-field" readonly="readonly" class="form-control">
					</div>
				</div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label>Region</label>
                        <select name="region" class="form-control" onchange="select_province()">
                        	<option disabled selected>SELECT REGION</option>
                            <option data-psgc="18" value="NIR">Region: NIR - Negros Island Region</option>
                            <option data-psgc="13" value="NCR">Region: NCR - National Capital Region</option>
                            <option data-psgc="14" value="CAR">Region: CAR - Cordillera Administrative Region</option>
                            <option data-psgc="01" value="ILOCOS">Region: REGION I (Ilocos Region)</option>
                            <option data-psgc="02" value="CAGAYAN-VALLEY">Region: REGION II (Cagayan Valley)</option>
                            <option data-psgc="03" value="CENTRAL-LUZON">Region: REGION III (Central Luzon)</option>
                            <option data-psgc="04" value="CALABARZON">Region: REGION IV-A (CALABARZON)</option>
                            <option data-psgc="17" value="MIMAROPA">Region: REGION IV-B (MIMAROPA)</option>
                            <option data-psgc="05" value="BICOL">Region: REGION V (Bicol Region)</option>
                            <option data-psgc="06" value="WESTERN-VISAYAS">Region: REGION VI (Western Visayas)</option>
                            <option data-psgc="07" value="CENTRAL-VISAYAS">Region: REGION VII (Central Visayas)</option>
                            <option data-psgc="08" value="EASTERN-VISAYAS">Region: REGION VIII (Eastern Visayas)</option>
                            <option data-psgc="09" value="ZAMBOANGA">Region: REGION IX (Zamboanga Peninsula)</option>
                            <option data-psgc="10" value="NORTHERN-MINDANAO">Region: REGION X (Northern Mindanao)</option>
                            <option data-psgc="11" value="DAVAO">Region: REGION XI (Davao Region)</option>
                            <option data-psgc="12" value="SOCCSKARGEN">Region: REGION XII (Soccsksargen)</option>
                            <option data-psgc="16" value="CARAGA">Region: REGION XIII (Caraga)</option>
                            <option data-psgc="15" value="ARMM">Region: ARMM - Autonomous Region in Muslim Mindana</option>
                        </select>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label>Year</label>
                        <select name="year" class="form-control">
                            <option value="2000">2000</option>
                            <option value="2001">2001</option>
                            <option value="2002">2002</option>
                            <option value="2003">2003</option>
                            <option value="2004">2004</option>
                            <option value="2005">2005</option>
                            <option value="2006">2006</option>
                            <option value="2007">2007</option>
                            <option value="2008">2008</option>
                            <option value="2009">2009</option>
                            <option value="2010">2010</option>
                            <option value="2011">2011</option>
                            <option value="2012">2012</option>
                            <option value="2013">2013</option>
                            <option value="2014">2014</option>
                            <option value="2015">2015</option>
                            <option value="2016">2016</option>
                            <option value="2017">2017</option>
                            <option value="2018">2018</option>
                            <option value="2019">2019</option>
                            <option value="2020">2020</option>
                        </select>
                    </div>
                </div>
				<div class="col-md-12">
					<div class="form-group">
						<label>Description</label>
						<textarea class="form-control" rows="6" name="description"></textarea>
					</div>
				</div>
				<div class="col-md-12" style="display: none;"><h4 class="background"><span>Upload Pictures & KML Files</span></h4></div>
				<div class="col-xs-12" style="display: none;">
					<div class="dropzone" id="dropzone-1">
						<div class="dz-message">Drop Image & KML Files here to upload</div>
					</div>
				</div>
				<div class="col-md-12" style="display: none;"><h4 class="background"><span>Upload Special Findings, Observations, and Other Files</span></h4></div>
				<div class="col-xs-12" style="display: none;">
					<div class="dropzone" id="dropzone-2">
						<div class="dz-message">Drop Special Findings Images here to upload</div>
					</div>
				</div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>Contract Cost</label>
						<input type="text" name="contract-cost" required="required" class="form-control" />
					</div>
				</div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>Total Project Cost</label>
						<input type="text" name="total-project-cost" required="required" class="form-control" />
					</div>
				</div>
				<div class="col-md-12"><h4 class="background"><span>Location</span></h4></div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>Province</label>
						<!-- <input type="text" name="province" class="form-control" disabled=""> -->
						<select name="province" class="form-control" required="required" disabled="" onchange="select_municipality();"></select>
					</div>
				</div>
				<div class="col-xs-6">
					<div class="form-group">
						<label>Municipality</label>
						<!-- <input type="text" name="municipality" class="form-control" disabled=""> -->
						<select name="municipality" required="required" class="form-control" disabled=""></select>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-4" id="dashboard-sidebar">
			{% if code %}
			<h4 class="background"><span>Datasets</span></h4>
			<ul class="list-inline">
				<li>
					<a href="/projects/{{ program }}/{{ code }}/subproject/{{ subproject }}/dataset/new" class="btn btn-xs btn-success" {% if not has_environment or not subproject %}disabled{% endif %}>Add a New Dataset</a>
				</li>
			</ul>
			<ul class="list-unstyled datasets-list"></ul>
			{% endif %}
			<ul class="list-unstyled reports-list"></ul>
			<h4 class="background"><span>Subproject Preview</span></h4>
			<div class="subproject-preview">
                <div id="sample-label" style="display: none;">&nbsp;Sample Data&nbsp;</div>
				<div style="padding: 1em 0;">
					<span class="preview-type">MIMAROPA</span>
					<span class="preview-id">IB-R04B-ORM-0001-VIC-0000-14</span>
				</div>
				<div style="margin: 1em 0;"><span class="preview-name">Concreting of Bagong Silang - Macatoc FMR</span> <span class="preview-status">2014</span></div>
				<div class="preview-description">Concreting of 1.851 km farm to market road with 5 meter wide with sectional concreting works of 420.40 meters by 1 meter and 516.20 by 2 meters.</div>
				<div class="preview-label">Province: <span class="preview-province">Oriental Mindoro</span></div>
				<div class="preview-label">Municipality: <span class="preview-municipality">Victoria</span></div>
				<div class="preview-label">Contract Cost: <span class="preview-contract-cost">1,234,567.89</span></div>
				<div class="preview-label">Total Project Cost: <span class="preview-total-project-cost">1,234,567.89</span></div>
			</div>
			<div class="form-group">
				{% if code %}
				<input type="hidden" name="data">
				<input type="submit" class="btn btn-block btn-success" value="Update" disabled="">
				{% else %}
				<input type="submit" class="btn btn-block btn-success" value="Create" disabled="">
				{% endif %}
			</div>
		</div>
	</form>
</div>

<div class="container">
    <h4 id="audit-logs-click-to-view">Audit Logs <small>Click to view</small></h4>

    <div id="project-logs-container">
    </div>
<br />
<br />
<br />
<br />
    
</div>


{% endblock %}
{% block script %}

<script type="text/template" id="template-log">
    <div class='log-item'>
        <span class='log-type'>%%type%%</span> 
        <span class='log-operation label label-%%label_class%%'>%%operation%%</span> 
        <span class='log-username'>by %%username%%</span> 
        <span class='log-time'>on %%time%%</span>
        <br />
        <br />
        <span class="log-details">%%details%%</span>
    </div>
</script>

<script type="text/javascript" src="/js/2.0/dropzone.min.js"></script>
<script type="text/javascript" src="/js/2.0/moment.min.js"></script>
<script type="text/javascript" src="/js/2.0/bootstrap-datepicker.min.js"></script>
<script type="text/javascript" src="/js/2.0/extensions.js"></script>
<script type="text/javascript" src="/js/2.0/dashboard.js"></script>
<script type="text/javascript" src="/js/2.0/dashboard.item.events.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-maskmoney/3.0.2/jquery.maskMoney.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/js/select2.min.js"></script>
<script src="https://cdn.ravenjs.com/3.0.4/raven.min.js"></script>
<script type="text/javascript">
	Raven.config('https://40dee6edeb0548f99e483cf64b74a5c1@app.getsentry.com/77892').install()
</script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-72730623-1', 'auto');
    ga('send', 'pageview');

</script>
<script type="text/javascript">
	var config = {
		'program': '{{ program }}',
		'subproject': '{{ subproject }}',
		'code': '{{ code }}',
		'loaded': {},
		'url': '{{ app_url }}',
		'locations': {},
	};
	get_psgc();
	Dropzone.autoDiscover = false;
	var dropzone_1 = new Dropzone("#dropzone-1", { url: "/upload/{{ program }}/{{ code }}"});
	var dropzone_2 = new Dropzone("#dropzone-2", { url: "/upload/{{ program }}/{{ code }}?special=1"});
	$('input[name*="-date"]').datepicker({format: 'MM d, yyyy'});
	$('input, textarea').on('keyup', function() {
		preview_subproject();
	});
    $('select').on('change', function() {
        preview_subproject();
    });
    $('input[name="total-project-cost"], input[name="contract-cost"]').maskMoney();
	{% if code and subproject %}
	setTimeout(function() {
		get_subproject(config.program, config.code, config.subproject);
		get_project_datasets(config.program, config.code, null, config.subproject);
	}, 1000);
    {% else %}
    $(document).ready(function(){
        $("#sample-label").show();
    });
	{% endif %}
</script>

<script type="text/javascript">

    function toTitleCase(str)
    {
        return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
    }

    function convert_json_to_normal(json_object){
        var normal_strings = [];
        for(var key in json_object){
            if(json_object[key] !== null && typeof json_object[key] === 'object'){
                normal_strings.push(convert_json_to_normal(json_object[key]));
            }
            else {
                normal_strings.push(toTitleCase(key).replace('/_/g', ' ') + ': ' + json_object[key]);
            }
        }
        return normal_strings.join('<br />');
    }


    function set_to_loading(){
        $("#project-logs-container").html("Loading...");
    }


    function pull_audit_logs(){
        set_to_loading();

        // get dataset changes
        url2 = '/api/v1/logs?code={{ code }}';
        $.getJSON(url2, function(data){
            if(data){
                console.log('logs 2', data);
                var logs = data.data;

                var html = '';

                for(var i=0; i<logs.length; i++){
                    template = $('#template-log').html();
                    template = template.replace('%%username%%', logs[i].username);
                    template = template.replace('%%operation%%', logs[i].operation);
                    template = template.replace('%%type%%', logs[i].details.type);
                    template = template.replace('%%time%%', logs[i].created);

                    template = template.replace('%%details%%', convert_json_to_normal(logs[i].details));

                    if(logs[i].operation == 'CREATED'){
                        template = template.replace('%%label_class%%', 'success');
                    }
                    else {
                        template = template.replace('%%label_class%%', 'info');
                    }

                    html += template;
                }

                $("#project-logs-container").html(html);
            }
        });
    }


    $(document).ready(function(){
        $("#audit-logs-click-to-view").on('click', function(){
            pull_audit_logs();
        });
    });
</script>
{% endblock %}